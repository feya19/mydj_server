# Docker Compose for mydj_server with security features

services:
  mydj-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mydj_server
    restart: unless-stopped
    
    # Security: Run with limited privileges but allow sudo for services
    security_opt:
      - no-new-privileges:false
    cap_add:
      - SYS_ADMIN  # Required for systemctl/service commands
    
    # Resource limits for DoS protection
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # Environment variables for security configuration
    environment:
      - WAZUH_MANAGER=${WAZUH_MANAGER:-192.168.1.100}
      - ENABLE_WAZUH=${ENABLE_WAZUH:-false}
      - ENABLE_FAIL2BAN=${ENABLE_FAIL2BAN:-true}
      - ENABLE_LOG_ROTATION=${ENABLE_LOG_ROTATION:-true}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-10485760}  # 10MB
      - ALLOWED_EXTENSIONS=${ALLOWED_EXTENSIONS:-jpg,jpeg,png,gif,mp4,avi,mov}
    
    # Port mapping
    ports:
      - "8000:8000"
    
    # Volume mounts
    volumes:
      - ./uploads:/app/uploads:rw
      - ./logs:/app/logs:rw
      - /var/log:/host/var/log:ro  # For log monitoring
      - /etc/localtime:/etc/localtime:ro  # Sync timezone
    
    # Network configuration
    networks:
      - mydj_network
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Wazuh Manager (optional - for development/testing)
  wazuh-manager:
    image: wazuh/wazuh-manager:4.7.0
    container_name: wazuh-manager
    restart: unless-stopped
    
    environment:
      - WAZUH_CLUSTER_NAME=wazuh-cluster
      - WAZUH_CLUSTER_NODE_NAME=master
      - WAZUH_CLUSTER_NODE_TYPE=master
    
    ports:
      - "1514:1514"   # Agent connections
      - "1515:1515"   # Agent enrollment
      - "9999:55000"  # Wazuh API (moved to port 9999)
    
    volumes:
      - wazuh_data:/var/ossec/data
      - wazuh_logs:/var/ossec/logs
      - wazuh_etc:/var/ossec/etc
      - ./config/wazuh/rules:/var/ossec/etc/rules/local_rules.xml:ro
    
    networks:
      - mydj_network
    
    profiles:
      - wazuh  # Only start with --profile wazuh

  # Elasticsearch for Wazuh (optional)
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.0
    container_name: wazuh-elasticsearch
    restart: unless-stopped
    
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
    
    ports:
      - "9200:9200"  # Elasticsearch API
    
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    
    networks:
      - mydj_network
    
    profiles:
      - wazuh

  # Kibana for Wazuh dashboard (optional)
  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.0
    container_name: wazuh-kibana
    restart: unless-stopped
    
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    
    ports:
      - "5602:5601"  # Kibana dashboard (moved to port 5602)
    
    depends_on:
      - elasticsearch
    
    networks:
      - mydj_network
    
    profiles:
      - wazuh

# Networks
networks:
  mydj_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volumes
volumes:
  wazuh_data:
  wazuh_logs:
  wazuh_etc:
  elasticsearch_data: